<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password - TBD Academy Portal</title>
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: var(--font-family-base);
        }

        .change-pw-container {
            width: 100%;
            max-width: 480px;
            padding: var(--space-6);
        }

        .change-pw-card {
            background: white;
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.15);
        }

        .change-pw-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .change-pw-icon {
            font-size: 3.5rem;
            margin-bottom: 0.75rem;
        }

        .change-pw-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0 0 0.5rem;
        }

        .change-pw-subtitle {
            color: #64748b;
            font-size: 0.9rem;
            margin: 0;
            line-height: 1.5;
        }

        .user-info-bar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .user-info-bar .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .user-info-bar .details {
            flex: 1;
            min-width: 0;
        }

        .user-info-bar .name {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
        }

        .user-info-bar .id {
            font-size: 0.78rem;
            color: #64748b;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #334155;
            margin-bottom: 0.4rem;
            font-size: 0.85rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1.5px solid #e2e8f0;
            border-radius: 0.625rem;
            font-size: 0.95rem;
            color: #1e293b;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
            background: #f8fafc;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
            background: white;
        }

        .form-input.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .password-wrapper {
            position: relative;
        }

        .password-wrapper input {
            padding-right: 2.75rem;
        }

        .toggle-pw-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: #94a3b8;
            padding: 0;
            line-height: 1;
        }

        .pw-requirements {
            margin: 0.5rem 0 0;
            padding: 0;
            list-style: none;
        }

        .pw-requirements li {
            font-size: 0.78rem;
            color: #94a3b8;
            padding: 0.15rem 0;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .pw-requirements li.met {
            color: #16a34a;
        }

        .pw-requirements li .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #cbd5e1;
            flex-shrink: 0;
        }

        .pw-requirements li.met .dot {
            background: #16a34a;
        }

        .pw-strength {
            height: 4px;
            border-radius: 4px;
            background: #e2e8f0;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .pw-strength-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s, background 0.3s;
            width: 0%;
        }

        .btn-submit {
            width: 100%;
            padding: 0.875rem;
            border-radius: 0.625rem;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
            margin-top: 0.5rem;
        }

        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.35);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-msg {
            color: #ef4444;
            font-size: 0.8rem;
            margin-top: 0.3rem;
            display: none;
        }

        .error-msg.show {
            display: block;
        }

        .alert {
            padding: 0.875rem 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.25rem;
            font-size: 0.88rem;
            display: none;
        }

        .alert.show {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert-danger {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .alert-success {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 0.4rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .success-state {
            text-align: center;
            padding: 1.5rem 0;
        }

        .success-state .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .success-state h2 {
            color: #16a34a;
            margin: 0 0 0.5rem;
            font-size: 1.35rem;
        }

        .success-state p {
            color: #64748b;
            margin: 0 0 1.5rem;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <div class="change-pw-container">
        <div class="change-pw-card">
            <!-- Header -->
            <div class="change-pw-header">
                <div class="change-pw-icon">üîê</div>
                <h1 class="change-pw-title">Change Your Password</h1>
                <p class="change-pw-subtitle">
                    Your account requires a password change before you can continue.
                    Please create a new secure password.
                </p>
            </div>

            <!-- User info bar (filled by JS) -->
            <div id="user-info-bar" class="user-info-bar" style="display:none;"></div>

            <!-- Alert -->
            <div id="alert-container"></div>

            <!-- Form -->
            <form id="change-pw-form">
                <div class="form-group">
                    <label class="form-label" for="currentPassword">Current Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="currentPassword" class="form-input"
                            placeholder="Enter your current password" required autocomplete="current-password">
                        <button type="button" class="toggle-pw-btn" onclick="toggleField('currentPassword', this)">üëÅÔ∏è</button>
                    </div>
                    <p class="error-msg" id="currentPassword-error"></p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="newPassword">New Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="newPassword" class="form-input"
                            placeholder="Create a new password" required autocomplete="new-password">
                        <button type="button" class="toggle-pw-btn" onclick="toggleField('newPassword', this)">üëÅÔ∏è</button>
                    </div>
                    <div class="pw-strength">
                        <div id="pw-strength-bar" class="pw-strength-bar"></div>
                    </div>
                    <ul class="pw-requirements" id="pw-requirements">
                        <li id="req-length"><span class="dot"></span> At least 8 characters</li>
                        <li id="req-upper"><span class="dot"></span> One uppercase letter</li>
                        <li id="req-lower"><span class="dot"></span> One lowercase letter</li>
                        <li id="req-number"><span class="dot"></span> One number</li>
                    </ul>
                    <p class="error-msg" id="newPassword-error"></p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="confirmPassword">Confirm New Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="confirmPassword" class="form-input"
                            placeholder="Confirm your new password" required autocomplete="new-password">
                        <button type="button" class="toggle-pw-btn" onclick="toggleField('confirmPassword', this)">üëÅÔ∏è</button>
                    </div>
                    <p class="error-msg" id="confirmPassword-error"></p>
                </div>

                <button type="submit" class="btn-submit" id="submit-btn">
                    Update Password
                </button>
            </form>

            <!-- Success state (hidden by default) -->
            <div id="success-state" class="success-state" style="display:none;">
                <div class="icon">‚úÖ</div>
                <h2>Password Updated!</h2>
                <p>Your password has been changed successfully. You will be redirected to the portal shortly.</p>
                <button class="btn-submit" id="continue-btn" onclick="continueToPortal()">
                    Continue to Portal
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/bcrypt.min.js"></script>
    <script src="js/auth-manager.js"></script>
    <script>
        // ‚îÄ‚îÄ State ‚îÄ‚îÄ
        const params = new URLSearchParams(window.location.search);
        const userId = params.get('userId') || '';
        let userSession = null;

        // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
        window.addEventListener('load', async () => {
            if (!userId) {
                showAlert('No user ID provided. Please log in again.', 'danger');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return;
            }

            // Wait for authManager to finish hydrating from Supabase
            let retries = 0;
            while (!authManager._ready && retries < 20) {
                await new Promise(r => setTimeout(r, 150));
                retries++;
            }

            // Show user info
            const bar = document.getElementById('user-info-bar');
            const session = authManager.getSession();
            if (session) {
                userSession = session;
                const initials = (session.fullName || userId).split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
                bar.innerHTML = `
                    <div class="avatar">${initials}</div>
                    <div class="details">
                        <div class="name">${session.fullName || 'User'}</div>
                        <div class="id">${userId} &middot; ${(session.role || 'user').charAt(0).toUpperCase() + (session.role || 'user').slice(1)}</div>
                    </div>
                `;
                bar.style.display = 'flex';
            }
        });

        // ‚îÄ‚îÄ Password strength checker ‚îÄ‚îÄ
        document.getElementById('newPassword').addEventListener('input', function () {
            const pw = this.value;
            const checks = {
                length: pw.length >= 8,
                upper: /[A-Z]/.test(pw),
                lower: /[a-z]/.test(pw),
                number: /[0-9]/.test(pw)
            };

            // Update requirement indicators
            Object.entries(checks).forEach(([key, met]) => {
                const el = document.getElementById('req-' + key);
                if (el) el.classList.toggle('met', met);
            });

            // Strength bar
            const score = Object.values(checks).filter(Boolean).length;
            const bar = document.getElementById('pw-strength-bar');
            const colors = ['#ef4444', '#f59e0b', '#eab308', '#16a34a'];
            bar.style.width = (score / 4 * 100) + '%';
            bar.style.background = colors[score - 1] || '#e2e8f0';

            // Clear confirm mismatch
            const confirm = document.getElementById('confirmPassword');
            if (confirm.value && confirm.value !== pw) {
                showFieldError('confirmPassword', 'Passwords do not match');
            } else {
                clearFieldError('confirmPassword');
            }
        });

        // ‚îÄ‚îÄ Confirm password live check ‚îÄ‚îÄ
        document.getElementById('confirmPassword').addEventListener('input', function () {
            const newPw = document.getElementById('newPassword').value;
            if (this.value && this.value !== newPw) {
                showFieldError('confirmPassword', 'Passwords do not match');
            } else {
                clearFieldError('confirmPassword');
            }
        });

        // ‚îÄ‚îÄ Form submit ‚îÄ‚îÄ
        document.getElementById('change-pw-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            clearAllErrors();

            const currentPw = document.getElementById('currentPassword').value;
            const newPw = document.getElementById('newPassword').value;
            const confirmPw = document.getElementById('confirmPassword').value;
            const btn = document.getElementById('submit-btn');

            // Validate
            let valid = true;
            if (!currentPw) { showFieldError('currentPassword', 'Current password is required'); valid = false; }
            if (newPw.length < 8) { showFieldError('newPassword', 'Password must be at least 8 characters'); valid = false; }
            if (!/[A-Z]/.test(newPw) || !/[a-z]/.test(newPw) || !/[0-9]/.test(newPw)) {
                showFieldError('newPassword', 'Password must contain upper, lower case and a number');
                valid = false;
            }
            if (newPw !== confirmPw) { showFieldError('confirmPassword', 'Passwords do not match'); valid = false; }
            if (currentPw === newPw) { showFieldError('newPassword', 'New password must be different from current'); valid = false; }
            if (!valid) return;

            // Submit
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Updating...';

            try {
                const result = await authManager.changePassword(userId, currentPw, newPw);

                if (result.success) {
                    // Hide form, show success
                    document.getElementById('change-pw-form').style.display = 'none';
                    document.getElementById('success-state').style.display = 'block';
                    document.querySelector('.change-pw-header').style.display = 'none';

                    // Auto-redirect after 3s
                    setTimeout(continueToPortal, 3000);
                } else {
                    showAlert(result.error || 'Failed to change password. Please try again.', 'danger');
                    btn.disabled = false;
                    btn.textContent = 'Update Password';
                }
            } catch (err) {
                showAlert('An unexpected error occurred. Please try again.', 'danger');
                btn.disabled = false;
                btn.textContent = 'Update Password';
            }
        });

        // ‚îÄ‚îÄ Continue to portal ‚îÄ‚îÄ
        function continueToPortal() {
            const session = authManager.getSession();
            if (session) {
                // Update local session via authManager's own method
                session.mustChangePassword = false;
                authManager._saveLocalSession(session);
                const redirectUrl = authManager.getRedirectUrl(session.role);
                window.location.href = redirectUrl;
            } else {
                window.location.href = 'login.html';
            }
        }

        // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
        function toggleField(id, btn) {
            const input = document.getElementById(id);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
            }
        }

        function showAlert(msg, type) {
            const container = document.getElementById('alert-container');
            const icon = type === 'danger' ? '‚ö†Ô∏è' : '‚úÖ';
            container.innerHTML = `<div class="alert alert-${type} show">${icon} ${msg}</div>`;
            if (type === 'danger') setTimeout(() => { container.innerHTML = ''; }, 6000);
        }

        function showFieldError(id, msg) {
            document.getElementById(id).classList.add('error');
            const errEl = document.getElementById(id + '-error');
            if (errEl) { errEl.textContent = msg; errEl.classList.add('show'); }
        }

        function clearFieldError(id) {
            document.getElementById(id).classList.remove('error');
            const errEl = document.getElementById(id + '-error');
            if (errEl) { errEl.textContent = ''; errEl.classList.remove('show'); }
        }

        function clearAllErrors() {
            document.querySelectorAll('.error-msg').forEach(el => { el.textContent = ''; el.classList.remove('show'); });
            document.querySelectorAll('.form-input').forEach(el => el.classList.remove('error'));
            document.getElementById('alert-container').innerHTML = '';
        }
    </script>
</body>

</html>
